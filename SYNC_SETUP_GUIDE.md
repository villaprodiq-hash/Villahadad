# ๐ ุฏููู ุฅุนุฏุงุฏ ุงููุฒุงููุฉ (Sync Setup Guide)

ูุฐุง ุงูุฏููู ูุดุฑุญ ููููุฉ ุฅุนุฏุงุฏ ุงููุฒุงููุฉ ุจูู ุงูุชุทุจูู ู Supabase.

---

## โก ุงูุฎุทูุงุช ุงููุทููุจุฉ

### 1. ุฅุถุงูุฉ ููุชุงุญ ุงูุฎุฏูุฉ (Service Role Key)

ูู ููู `.env` ุฃุถู:

```env
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your_anon_key_here
VITE_SUPABASE_SERVICE_KEY=your_service_role_key_here
```

**ููููุฉ ุงูุญุตูู ุนูู Service Role Key:**
1. ุงุฐูุจ ุฅูู Supabase Dashboard
2. ุงุฎุชุฑ ูุดุฑูุนู
3. Project Settings โ API
4. ุงูุณุฎ `service_role key` (ุงููุณู "service_role secrets")

โ๏ธ **ุชุญุฐูุฑ ุฃููู:** ูุฐุง ุงูููุชุงุญ ูุนุทู ูุตูู ูุงูู ููุงุนุฏุฉ ุงูุจูุงูุงุช. ูุง ุชุดุงุฑูู ุฃุจุฏุงู!

---

### 2. ุชุดุบูู ุฃูุงูุฑ SQL ูู Supabase

1. ุงูุชุญ Supabase Dashboard
2. ุงุฐูุจ ุฅูู SQL Editor
3. ุงูุณุฎ ูุญุชูู ููู [`supabase/setup_sync.sql`](supabase/setup_sync.sql)
4. ุดุบู ุงูุฃูุงูุฑ

**ูุง ุงูุฐู ุชูุนูู ูุฐู ุงูุฃูุงูุฑ:**
- โ ุชูุนูู Realtime ููุฌุฏุงูู (bookings, users, payments)
- โ ุฅุนุฏุงุฏ ุณูุงุณุงุช RLS ูููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู
- โ ุฅูุดุงุก ุฌุฏูู conflicts ูุญู ุชุนุงุฑุถุงุช ุงููุฒุงููุฉ
- โ ุฅูุดุงุก ููุงุฑุณ ูุชุญุณูู ุงูุฃุฏุงุก

---

### 3. ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช Realtime

1. Supabase Dashboard โ Database โ Replication
2. ุชุฃูุฏ ุฃู Realtime ูููุนู
3. ุชุญูู ุฃู ุงูุฌุฏุงูู ุงูุชุงููุฉ ููุฏุฑุฌุฉ:
   - `bookings`
   - `users`
   - `payments`
   - `conflicts`

---

## ๐ง ุงูุฅุตูุงุญุงุช ุงูุชู ุชูุช

### โ ุฅุตูุงุญ 1: ููู ุงููุฒุงููุฉ
**ุงูููู:** `src/services/sync/SyncManager.ts`

**ุงููุดููุฉ:** ุนูุฏูุง ุชููู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูุงุฑุบุฉุ ูุงู ุงูููู `syncInProgress` ูุจูู ููุญุชูุธุงู ุจู.

**ุงูุฅุตูุงุญ:**
```typescript
if (queueItems.length === 0) {
    console.log("โ SyncManager: Queue is empty.");
    this.syncInProgress = false; // ๐ ุชุญุฑูุฑ ุงูููู
    return;
}
```

### โ ุฅุตูุงุญ 2: ุงุณุชุฎุฏุงู Admin Client
**ุงูููู:** `src/services/sync/SyncManager.ts`

**ุงููุดููุฉ:** ูุงู ูุณุชุฎุฏู ุงูุนููู ุงูุนุงุฏู ุงูุฐู ูุฎุถุน ูู RLS.

**ุงูุฅุตูุงุญ:**
```typescript
const client = supabaseAdmin || supabase;
```

---

## ๐งช ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ

### ุงุฎุชุจุงุฑ 1: ุงููุฒุงููุฉ ุงูุฃุณุงุณูุฉ
1. ุงูุชุญ ุงูุชุทุจูู
2. ุฃุถู ุญุฌุฒ ุฌุฏูุฏ
3. ุชุญูู ูู Console - ูุฌุจ ุฃู ุชุฑู:
   ```
   ๐ฅ SyncQueue: Enqueued [create booking]
   ๐ SyncManager: Processing 1 offline items...
   โ Successfully synced item xxx
   ```

### ุงุฎุชุจุงุฑ 2: ุงููุฒุงููุฉ ุงููุญุธูุฉ
1. ุงูุชุญ ุงูุชุทุจูู ุนูู ุฌูุงุฒูู (ุฃู ูุงูุฐุชูู)
2. ุฃุถู ุญุฌุฒ ูู ุฃุญุฏููุง
3. ูุฌุจ ุฃู ูุธูุฑ ุงูุญุฌุฒ ูู ุงูุขุฎุฑ ุฎูุงู ุซูุงูู
4. ุชุญูู ูู Console:
   ```
   โก๏ธ CLOUD CHANGE (Bookings): INSERT {...}
   โฌ๏ธ SyncManager: Created Local Booking xxx
   ```

### ุงุฎุชุจุงุฑ 3: ูุถุน ุนุฏู ุงูุงุชุตุงู
1. ุงูุตู ุงูุฅูุชุฑูุช
2. ุฃุถู ุญุฌุฒ ุฌุฏูุฏ
3. ุชุญูู ุฃูู ุฃูุถูู ุฅูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ:
   ```
   ๐ฅ SyncQueue: Enqueued [create booking]
   ```
4. ุฃุนุฏ ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช
5. ูุฌุจ ุฃู ุชุชู ุงููุฒุงููุฉ ุชููุงุฆูุงู

---

## ๐จ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: "Sync already in progress"
**ุงูุญู:** ุชู ุฅุตูุงุญูุง - ุงูููู ููุญุฑุฑ ุงูุขู ุจุดูู ุตุญูุญ.

### ุงููุดููุฉ: "RLS policy violation"
**ุงูุญู:**
- ุชุฃูุฏ ูู ุฅุถุงูุฉ `VITE_SUPABASE_SERVICE_KEY`
- ุฃู ุดุบู ุฃูุงูุฑ SQL ูุฅุนุฏุงุฏ RLS

### ุงููุดููุฉ: "Realtime not working"
**ุงูุญู:**
1. ุชุญูู ูู Supabase Dashboard โ Database โ Replication
2. ุชุฃูุฏ ุฃู ุงูุฌุฏุงูู ูููุนูุฉ ูู Realtime
3. ุชุญูู ูู Console - ูุฌุจ ุฃู ุชุฑู:
   ```
   โ Real-time bookings sync active!
   ```

### ุงููุดููุฉ: "VITE_SUPABASE_SERVICE_KEY is missing"
**ุงูุญู:** ุฃุถู ุงูููุชุงุญ ูู `.env` ุซู ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู.

---

## ๐ ููู ุขููุฉ ุงููุฒุงููุฉ

```
โโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโ
โ   Local SQLite  โโโโโโถโ   Sync Queue    โโโโโโถโ   Supabase      โ
โ   (Offline)     โ     โ   (Pending)     โ     โ   (Cloud)       โ
โโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโ
         โ                                               โ
         โ                                               โ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ         Realtime Subscription
         โ
    User sees
    instant updates
```

### ุงูููููุงุช:
1. **SyncQueue** - ูุงุฆูุฉ ุงูุชุธุงุฑ ูุญููุฉ ููุนูููุงุช ุบูุฑ ุงููุชุฒุงููุฉ
2. **SyncManager** - ูุฏูุฑ ุนูููุฉ ุงููุฒุงููุฉ
3. **supabaseAdmin** - ุนููู ุจุตูุงุญูุงุช ูุงููุฉ ูููุฒุงููุฉ
4. **Realtime** - ุงุดุชุฑุงู ูู ุชุบููุฑุงุช ุงูุณุญุงุจุฉ

---

## โ ูุงุฆูุฉ ุงูุชุญูู

- [ ] ุฃุถูุช `VITE_SUPABASE_SERVICE_KEY` ุฅูู `.env`
- [ ] ุดุบูุช ุฃูุงูุฑ SQL ูู Supabase
- [ ] ูุนูุช Realtime ููุฌุฏุงูู ุงููุทููุจุฉ
- [ ] ุงุฎุชุจุฑุช ุงููุฒุงููุฉ ุงูุฃุณุงุณูุฉ
- [ ] ุงุฎุชุจุฑุช ุงููุฒุงููุฉ ุงููุญุธูุฉ
- [ ] ุงุฎุชุจุฑุช ูุถุน ุนุฏู ุงูุงุชุตุงู

---

## ๐ ุฏุนู

ุฅุฐุง ูุงุฌูุช ูุดุงูู:
1. ุชุญูู ูู Console ููุฃุฎุทุงุก
2. ุชุฃูุฏ ูู ุฌููุน ุงูุฎุทูุงุช ุฃุนูุงู
3. ุฑุงุฌุน ููู `CHANGELOG.md` ููุชุบููุฑุงุช ุงูุฃุฎูุฑุฉ
