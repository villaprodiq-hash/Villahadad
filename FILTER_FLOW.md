# تدفق الفلترة: فيلا vs سرى

## 🔄 تدفق إنشاء الحجز الكامل

```
┌─────────────────────────────────────────────────────────────────┐
│                    1. الضغط على زر "حجز جديد"                    │
│                      أو "حجز موقع الفيلا"                         │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                    2. فتح المودال بالـ mode                      │
│                                                                  │
│   ┌─────────────────────┐          ┌─────────────────────┐      │
│   │  mode = "shoot"     │          │  mode = "location"  │      │
│   │  (زر الحجز العادي)  │          │  (زر موقع الفيلا)   │      │
│   └──────────┬──────────┘          └──────────┬──────────┘      │
│              │                                 │                 │
│              ▼                                 ▼                 │
│   ┌─────────────────────┐          ┌─────────────────────┐      │
│   │ selectedCategoryId  │          │ selectedCategoryId  │      │
│   │   = EVENT_TYPES[0]  │          │       = "venue"     │      │
│   │       = "vip"       │          │                     │      │
│   └─────────────────────┘          └─────────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                    3. في وضع "venue" (Location)                  │
│                                                                  │
│   تظهر 4 تابات لاختيار نوع حجز الموقع:                            │
│                                                                  │
│   ┌──────────┬──────────┬──────────┬──────────┐                  │
│   │ مناسبات  │  غرفة   │ جلسات   │  إعلاني  │                  │
│   │ الموقع   │   VIP   │         │          │                  │
│   │ (party)  │ (room)  │(session)│(commercial)│                 │
│   │  فلتر:   │  فلتر:  │  فلتر:  │  فلتر:   │                  │
│   │ "venue"  │ "venue" │ "venue" │ "venue"  │                  │
│   └──────────┴──────────┴──────────┴──────────┘                  │
│               venueTab = 'venue_party' | 'venue_room' |          │
│                         'venue_session' | 'venue_commercial'     │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│              4. تحديد الباقة والبيانات الأساسية                   │
│                                                                  │
│   ┌─────────────────────────────────────┐                        │
│   │ const eventType =                   │                        │
│   │   EVENT_TYPES.find(e => e.id ===    │                        │
│   │                      selectedCategoryId)                      │
│   │ // بالنسبة للـ venue:               │                        │
│   │ // eventType.mapTo = BookingCategory.LOCATION                │
│   └─────────────────────────────────────┘                        │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                    5. عند حفظ الحجز                              │
│                                                                  │
│   ┌───────────────────────────────────────────────────┐          │
│   │ دردشة مع الذكاء لتحديد eventType:                  │          │
│   │                                                    │          │
│   │ Event Type   │  mapTo             │  فلتر Villa    │          │
│   │ ─────────────┼────────────────────┼─────────────── │          │
│   │ vip          │ WEDDING            │ ❌ سرى         │          │
│   │ wedding_party│ WEDDING            │ ❌ سرى         │          │
│   │ wedding_studio│ STUDIO            │ ❌ سرى         │          │
│   │ kids         │ BIRTHDAY           │ ❌ سرى         │          │
│   │ general      │ GRADUATION         │ ❌ سرى         │          │
│   │ printing     │ TRANSACTION        │ ❌ سرى         │          │
│   │ location     │ LOCATION ⭐         │ ✅ فيلا        │          │
│   └───────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                    6. الحجز يُحفظ في قاعدة البيانات              │
│                    مع الـ BookingCategory الصحيحة                 │
│                                                                  │
│   booking.category = formData.category  // هنا LOCATION أو غيرها │
└─────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════

## 🔍 تدفق قراءة الفلترة: Villa vs Sura

```
┌─────────────────────────────────────────────────────────────────┐
│                    قراءة الحجز من قاعدة البيانات                 │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                  الفلتر الأساسي: !deletedAt                      │
│                                                                  │
│   ┌──────────────────────────────────────────┐                   │
│   │ activeBookings = bookings.filter(b =>    │                   │
│   │   !b.deletedAt  // تجاهل المحذوفات       │                   │
│   │ )                                         │                   │
│   └──────────────────────────────────────────┘                   │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                  الفلتر الرئيسي: Villa vs Sura                   │
│                                                                  │
│   ┌────────────────────────────────────────────────────┐         │
│   │ const isVilla =                                    │         │
│   │   (b.category || '').toLowerCase() === 'location'  │         │
│   │                                                    │         │
│   │ // Villa: category === 'Location'                  │         │
│   │ // Sura:  كل الباقي (Wedding, Studio, etc.)        │         │
│   └────────────────────────────────────────────────────┘         │
│                                                                  │
│   ┌────────────────────────┐    ┌────────────────────────┐       │
│   │    ✅ Villa (فيلا)     │    │    ❌ Sura (سرى)       │       │
│   │                        │    │                        │       │
│   │ تأجير موقع الفيلا      │    │ زفاف - مناسبات         │       │
│   │ غرفة VIP               │    │ استوديو                │       │
│   │ مناسبات الموقع         │    │ جلسات تصوير            │       │
│   │ جلسات الموقع           │    │ أعياد ميلاد            │       │
│   │ إعلاني                 │    │ تخرج                   │       │
│   │                        │    │ طباعة                  │       │
│   └────────────────────────┘    └────────────────────────┘       │
│                                                                  │
│   المشكلة السابقة: case-sensitive!                              │
│   'Location' !== 'location' → Villa لم تظهر!                    │
│                                                                  │
│   الحل: .toLowerCase() قبل المقارنة!                            │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│               تطبيقات الفلترة المختلفة                            │
│                                                                  │
│   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐     │
│   │ Manager        │  │ Financial      │  │ Reception      │     │
│   │ Dashboard      │  │ Accounts View  │  │ Dashboard      │     │
│   │                │  │                │  │                │     │
│   │ sourceFilter:  │  │ sourceFilter:  │  │ filter:        │     │
│   │ - villa        │  │ - villa        │  │ - villa/sura   │     │
│   │ - sura         │  │ - sura         │  │ - all          │     │
│   │ - all          │  │ - all          │  │                │     │
│   └────────────────┘  └────────────────┘  └────────────────┘     │
└─────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════

## 📊 حالات فلترة Villa السابقة (المشاكل)

```
┌──────────────────────────────────────────────────────────────────┐
│  المشكلة 1: Case-Sensitivity                                     │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  قاعدة البيانات تحتوي:                                          │
│  ┌────────────────────────────────────────────┐                 │
│  │ booking.category = 'Location'  (first: L)  │                 │
│  └────────────────────────────────────────────┘                 │
│                                                                  │
│  الكود القديم:                                                   │
│  ┌────────────────────────────────────────────┐                 │
│  │ b.category === 'location'  // ❌ false!    │                 │
│  │ 'Location' !== 'location'                  │                 │
│  └────────────────────────────────────────────┘                 │
│                                                                  │
│  النتيجة: Villa مُفلترة كـ Sura!  ❌ خطأ كبير                    │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│  المشكلة 2: undefined values                                     │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  بعض الحجوزات ليس لها category:                                  │
│  ┌────────────────────────────────────────────┐                 │
│  │ booking.category = undefined               │                 │
│  └────────────────────────────────────────────┘                 │
│                                                                  │
│  الكود القديم:                                                   │
│  ┌────────────────────────────────────────────┐                 │
│  │ b.category.toLowerCase()  // ❌ ERROR!     │                 │
│  └────────────────────────────────────────────┘                 │
│                                                                  │
│  الحل: (b.category || '').toLowerCase()                          │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════

## ✅ الكود المُصلح

```typescript
// الملف: ManagerAccountsView.tsx (السطر 232)

// ✅ الفلتر الصحيح للفيلا
const isVilla = (b.category || '').toLowerCase() === 'location';

// الاستخدامات:
if (isVilla) {
    // إيرادات فيلا حداد
    revenueVillaUSD += amount;
} else {
    // إيرادات سرى الحداد
    revenueSuraUSD += amount;
}

// ==== في الفلتر ====
if (sourceFilter === 'villa') return isVilla;
if (sourceFilter === 'sura') return !isVilla;
```


═══════════════════════════════════════════════════════════════════════

## 📝 ملخص التدفق

1. **الإنشاء**: المستخدم يختار نوع الحجز (event type)
2. **التحويل**: `EVENT_TYPES[id].mapTo` يُحوّل إلى `BookingCategory`
3. **الحفظ**: `booking.category` يحفظ في قاعدة البيانات
4. **القراءة**: `category.toLowerCase() === 'location'` تحدد Villa/Sura
5. **العرض**: الفلتر يُظهر الإحصائيات المناسبة


### الكلمات المفتاحية:
- **Villa/Fila حداد** = `category === 'Location'`
- **Sura/سرى الحداد** = كل الأنواع الأخرى (Wedding, Studio, etc.)
